--disable_query_log
set @@session.explicit_defaults_for_timestamp=off;
--enable_query_log
#owner: yanmu.ztl
#owner group:sql2
#description:information_schema test
# This test  uses grants, which can't get tested for embedded server
#-- source mysql_test/include/big_test.inc
-- source mysql_test/include/not_embedded.inc

# check that CSV engine was compiled in, as the result of the test depends
# on the presence of the log tables (which are CSV-based).
#--source mysql_test/include/have_csv.inc

connect (obsys,$OBMYSQL_MS0,admin,$OBMYSQL_PWD,test,$OBMYSQL_PORT);
connection obsys;

create user testtt1 identified by 'testtt1';
create database tt1_test;
GRANT ALL ON *.* TO testtt1;

--source mysql_test/include/check_schema_sync.inc
connect (conn1,$OBMYSQL_MS0,testtt1@sys,testtt1,tt1_test,$OBMYSQL_PORT);
connection conn1;

--disable_query_log
set @@session.ob_query_timeout = 30000000;
--enable_query_log
use test;
#
--disable_warnings
DROP TABLE IF EXISTS t0,t1,t2,t3,t4,t5;
--disable_warnings
DROP VIEW IF EXISTS v1;
--enable_warnings


--echo #
--echo # Bug#18925: subqueries with MIN/MAX functions on INFORMARTION_SCHEMA
--echo #
--sorted_result
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = t.table_schema AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';
--sorted_result
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = 'information_schema' AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';
connect (conn_root,$OBMYSQL_MS0,root@sys,,*NO-ONE*,$OBMYSQL_PORT);
connection conn_root;
--disable_query_log
set @@session.ob_query_timeout = 30000000;
--enable_query_log
--sorted_result
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = t.table_schema AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';
--sorted_result
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = 'information_schema' AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';

select 1;
connection conn1;
use test;
create table if not exists t1(i1 int, v2 varchar(80), i3 char(20),i4 float, d4 datetime(6),i5 decimal(5,3), primary key(i1));
connection conn1;
create table if not exists t2(i1 int, v2 varchar(80), i3 char(20),i4 float, d4 datetime(6),i5 decimal(5,3), primary key(i1));
connection conn1;
create table if not exists t3(i1 int, v2 varchar(80), i3 char(20),i4 float, d4 datetime(6),i5 decimal(5,3), primary key(i1));
connection conn1;
create table if not exists t4(i1 int, v2 varchar(80), i3 char(20),i4 float, d4 datetime(6),i5 decimal(5,3), primary key(i1));
connection conn1;
--disable_query_log
set @@session.ob_query_timeout = 30000000;
--enable_query_log
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = t.table_schema AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';
--sorted_result
SELECT t.table_name, c1.column_name
  FROM information_schema.tables t
       INNER JOIN
       information_schema.columns c1
       ON t.table_schema = c1.table_schema AND
          t.table_name = c1.table_name
  WHERE t.table_schema = 'information_schema' AND
        c1.ordinal_position =
        ( SELECT COALESCE(MIN(c2.ordinal_position),1)
            FROM information_schema.columns c2
            WHERE c2.table_schema = 'information_schema' AND
                  c2.table_name = t.table_name AND
                  c2.column_name LIKE '%SCHEMA%')
  AND t.table_name NOT LIKE 'ndb%'
AND t.table_name NOT LIKE 'innodb%';
